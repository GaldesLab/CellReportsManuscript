//Asks user to select the folder that needs to be analysed
//This macro will apply to all tif images within the selected folder


dir = getDirectory("Select Source Directory");
list = getFileList(dir);
Array.sort(list);

for(i=0; i<list.length; i++){
filename = dir + list[i];
if (endsWith(filename, "tif")){
open(filename);

//Stores the name of the title of the image. Files that are saved by this
//macro will use the name of the image at the beginning
nameStore = getTitle();
dir1 = File.directory;

run("Color Threshold...");
// Color Thresholder 2.0.0-rc-34/1.50a
// Autogenerated macro, single images only!
min=newArray(3);
max=newArray(3);
filter=newArray(3);
a=getTitle();
run("HSB Stack");
run("Convert Stack to Images");
selectWindow("Hue");
rename("0");
selectWindow("Saturation");
rename("1");
selectWindow("Brightness");
rename("2");
min[0]=0;
max[0]=255;
filter[0]="pass";
min[1]=90;
max[1]=255;
filter[1]="pass";
min[2]=160;
max[2]=255;
filter[2]="pass";
for (i=0;i<3;i++){
  selectWindow(""+i);
  setThreshold(min[i], max[i]);
  run("Convert to Mask");
  if (filter[i]=="stop")  run("Invert");
}
imageCalculator("AND create", "0","1");
imageCalculator("AND create", "Result of 0","2");
for (i=0;i<3;i++){
  selectWindow(""+i);
  close();
}
selectWindow("Result of 0");
close();
selectWindow("Result of Result of 0");
rename(a);
// Colour Thresholding-------------
run("Analyze Particles...", "  show=Masks clear summarize");
saveAs("Tiff", dir+nameStore+" - Thresholded");
saveAs("Results", dir+nameStore+" - Area.txtâ€);
run("Close All");
}
}
